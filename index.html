{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">

  <!-- Welcome Section -->
  <section class="card shadow p-4 mb-5" style="background-color: #E8E1DA;">
    <h1 class="text-center" style="color: #FEB856;">Welcome to Projexis</h1>
    <p class="text-center">Brainstorm your next creative project with our bot. Once you're ready, we’ll help you make it real!</p>
    <p class="text-center">If you already have an idea, skip the chat and go straight to the resources!</p>
  </section>

  <!-- Project Idea Section -->
  <section class="card shadow p-4 mb-5" style="background-color: #E8E1DA;">
    <h2 class="text-center" style="color: #FEB856;">What’s Your Craft Idea?</h2>
    <form id="ideaForm" class="text-center mt-3">
      <div class="input-group" style="max-width: 600px; margin: auto;">
        <input type="text" id="idea" name="idea" class="form-control" placeholder="e.g., Crochet coasters" required />
        <button type="submit" class="btn" style="background-color: #FEB856;">Find Tutorials</button>
      </div>
    </form>
  </section>

  <!-- YouTube Videos Section -->
  <section id="video-section" class="card shadow p-4 mb-5" style="background-color: #E8E1DA; display: none;">
    <h2 class="text-center mb-4" style="color: #FEB856;">Video Tutorials for Your Idea</h2>
    <div class="swiper">
      <div class="swiper-wrapper" id="video-carousel"></div>
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
    </div>
  </section>

  <!-- Store Locator Section -->
  <section class="card shadow p-4 mb-5" style="background-color: #E8E1DA;">
    <h2 class="text-center" style="color: #FEB856;">Where to Buy Materials</h2>
    <form id="locationForm" class="text-center mt-3">
      <div class="input-group" style="max-width: 600px; margin: auto;">
        <input type="text" id="zip" class="form-control" placeholder="Enter your city or zip code" required />
        <button type="submit" class="btn" style="background-color: #FEB856;">Search Stores</button>
      </div>
    </form>
    <div id="map" class="mt-4" style="height: 400px; border-radius: 8px; display: none;"></div>
  </section>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.4" integrity="sha384-zUfuhFKKZCbHTY6aRR46gxiqszMk5tcHjsVFxnUo8VMus4kHGVdIYVbOYYNlKmHV" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // YouTube API
  document.getElementById('ideaForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const idea = document.getElementById('idea').value;
    const response = await fetch(`/chatBot/api/youtube/?q=${encodeURIComponent(idea)}`);
    const data = await response.json();
    const container = document.getElementById("video-carousel");
    container.innerHTML = "";

    if (data.videos && data.videos.length > 0) {
      data.videos.forEach(video => {
        const slide = document.createElement("div");
        slide.className = "swiper-slide";
        slide.innerHTML = `
          <a href="https://www.youtube.com/watch?v=${video.videoId}" target="_blank">
            <img src="${video.thumbnail}" alt="${video.title}" class="img-fluid rounded" />
            <p class="mt-2" style="font-weight:bold;">${video.title}</p>
          </a>`;
        container.appendChild(slide);
      });

      document.getElementById('video-section').style.display = 'block';

      new Swiper('.swiper', {
        slidesPerView: 2.5,
        spaceBetween: 15,
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        },
        breakpoints: {
          0: { slidesPerView: 1 },
          600: { slidesPerView: 1.5 },
          900: { slidesPerView: 2.5 }
        }
      });
    } else {
      container.innerHTML = "<p class='text-center'>No tutorials found. Try a different idea!</p>";
      document.getElementById('video-section').style.display = 'block';
    }
  });

  // Google Maps API
  document.getElementById('locationForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const address = document.getElementById('zip').value;
    const geocoder = new google.maps.Geocoder();

    geocoder.geocode({ address: address }, function (results, status) {
      if (status === 'OK') {
        const userLocation = results[0].geometry.location;
        const map = new google.maps.Map(document.getElementById("map"), {
          center: userLocation,
          zoom: 13,
        });

        const request = {
          location: userLocation,
          radius: '5000',
          keyword: 'craft store',
        };

        const service = new google.maps.places.PlacesService(map);
        service.nearbySearch(request, function (results, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            document.getElementById('map').style.display = 'block'; // Show map only if search is successful
            results.forEach(place => {
              new google.maps.Marker({
                map,
                position: place.geometry.location,
                title: place.name,
              });
            });
          } else {
            alert('No stores found nearby!');
          }
        });
      } else {
        alert('Could not find that location: ' + status);
      }
    });
  });
});

// HTMX After Swap
document.body.addEventListener('htmx:afterSwap', function(evt) {
  // Extra reinitializations if needed
});
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNAvLo-Yzk7JNBVfIjuWipvTlx7MWWHtg&libraries=places">
</script>
{% endblock %}
